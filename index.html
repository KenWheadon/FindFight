<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rusty vs. The Evil Tree</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style" />
    <link rel="preload" href="loading-screen.css" as="style" />
    <link rel="preload" href="start-screen.css" as="style" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="loading-screen.css" />
    <link rel="stylesheet" href="start-screen.css" />

    <!-- Font preloads -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Meta tags -->
    <meta
      name="description"
      content="Rusty vs. The Evil Tree - A Hidden Object Adventure Game"
    />
    <meta name="author" content="Game Developer" />
    <meta name="theme-color" content="#1a1a2e" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
  </head>
  <body>
    <!-- Loading Screen -->
    <div class="screen loading-screen active" id="loading-screen">
      <div class="loading-content">
        <img
          src="images/logo.png"
          alt="Game Logo"
          class="loading-logo"
          id="loadingLogo"
        />
        <h1 class="loading-text" id="loadingText">Loading...</h1>
        <div class="loading-bar-container">
          <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-percentage" id="loadingPercentage">0%</div>
      </div>

      <!-- Background layers -->
      <div class="stars-layer"></div>
      <div class="asteroids-layer"></div>
      <div class="particles-layer"></div>
    </div>

    <!-- Start Screen -->
    <div class="screen start-screen" id="start-screen">
      <div class="start-content">
        <h1 class="game-title">Rusty vs. The Evil Tree</h1>
        <p class="game-subtitle">A Hidden Object Adventure</p>

        <div class="magical-box" id="magicalBox">
          <div class="box-content">
            <div class="box-icon">ü¶ù</div>
            <div class="box-text">Click to Open</div>
          </div>
        </div>

        <div class="story-intro" id="storyIntro">
          <p class="narrative-text">
            "Name's Rusty. Rusty the Raccoon. Been chasing cases longer than
            I've had this trench coat. But this one? This one smelled...
            ancient. A wooden box, sealed tight and tied to vanishing people.
            They hired me to investigate. I opened it. Now I'm <em>in</em> it.
            And there's something down here with roots deeper than reason."
          </p>
        </div>

        <div class="start-buttons">
          <button class="game-button primary" id="startGameBtn">
            Begin Adventure
          </button>
          <button class="game-button secondary" id="settingsBtn">
            Settings
          </button>
        </div>
      </div>

      <!-- Background layers -->
      <div class="stars-layer"></div>
      <div class="asteroids-layer"></div>
      <div class="particles-layer"></div>
    </div>

    <!-- Hidden Object Screen (placeholder for future implementation) -->
    <div class="screen hidden-object-screen" id="hidden-object-screen">
      <div class="screen-content">
        <h2>Hidden Object Phase</h2>
        <p>This screen will be implemented next...</p>
      </div>
    </div>

    <!-- Combat Screen (placeholder for future implementation) -->
    <div class="screen combat-screen" id="combat-screen">
      <div class="screen-content">
        <h2>Combat Phase</h2>
        <p>This screen will be implemented next...</p>
      </div>
    </div>

    <!-- Victory Screen (placeholder for future implementation) -->
    <div class="screen victory-screen" id="victory-screen">
      <div class="screen-content">
        <h2>Victory!</h2>
        <p>You have defeated the Evil Tree!</p>
        <button class="game-button" onclick="game.restartGame()">
          Play Again
        </button>
      </div>
    </div>

    <!-- Game Over Screen (placeholder for future implementation) -->
    <div class="screen game-over-screen" id="game-over-screen">
      <div class="screen-content">
        <h2>Game Over</h2>
        <p>The Evil Tree has defeated you...</p>
        <button class="game-button" onclick="game.restartGame()">
          Try Again
        </button>
      </div>
    </div>

    <!-- Scripts - Order matters! -->
    <script src="config.js"></script>
    <script>
      // Use the updated Screen class instead of the external screen.js
      // Generic Screen Base Class - Common functionality for all game screens
      class Screen {
        constructor(container, screenName) {
          this.container = container;
          this.screenName = screenName;
          this.isActive = false;
          this.audioManager = null;
          this.particleSystem = null;
          this.intervals = [];
          this.timeouts = [];
          this.isShaking = false;
          this.config = GAME_CONFIG?.screens?.[screenName] || {};
          this.animConfig = GAME_CONFIG?.animations || {};
          console.log(`üöÄ ${screenName} Screen instance created`);
        }

        init() {
          this.render();
          this.setupEventListeners();
          this.startAnimations();
          this.initializeAudio();
          this.startParticleSystem();
          this.isActive = true;
          console.log(`‚úÖ ${this.screenName} Screen initialized`);
        }

        render() {
          console.warn(
            `render() method should be overridden in ${this.screenName}Screen`
          );
        }

        setupEventListeners() {
          document.addEventListener(
            "click",
            () => {
              this.enableAudio();
            },
            { once: true }
          );
          document.addEventListener("keydown", (e) => {
            if (this.isActive) {
              this.handleKeydown(e);
            }
          });
        }

        handleKeydown(e) {
          if (e.code === "Escape") {
            this.handleEscape();
          }
        }

        handleEscape() {
          console.log(`Escape pressed on ${this.screenName} screen`);
        }

        startAnimations() {
          this.createStars();
          this.createAsteroids();
        }

        createStars() {
          const starsContainer = this.container.querySelector(".stars-layer");
          if (!starsContainer) return;
          const { starCount = 50 } = this.animConfig;
          starsContainer.innerHTML = "";
          for (let i = 0; i < starCount; i++) {
            const star = document.createElement("div");
            star.className = "star";
            const size = Math.random() * 4 + 1;
            star.style.left = Math.random() * 100 + "%";
            star.style.top = Math.random() * 100 + "%";
            star.style.width = star.style.height = size + "px";
            star.style.animationDelay = Math.random() * 4 + "s";
            star.style.animationDuration = 3 + Math.random() * 2 + "s";
            starsContainer.appendChild(star);
          }
        }

        createAsteroids() {
          const asteroidsContainer =
            this.container.querySelector(".asteroids-layer");
          if (!asteroidsContainer) return;
          const { asteroidCount = 8 } = this.animConfig;
          asteroidsContainer.innerHTML = "";
          for (let i = 0; i < asteroidCount; i++) {
            const asteroid = document.createElement("div");
            asteroid.className = "asteroid";
            const size = Math.random() * 50 + 30;
            asteroid.style.width = asteroid.style.height = size + "px";
            asteroid.style.left = Math.random() * 90 + "%";
            asteroid.style.top = Math.random() * 90 + "%";
            asteroid.style.animationDelay = Math.random() * 8 + "s";
            asteroid.style.animationDuration = 6 + Math.random() * 4 + "s";
            asteroidsContainer.appendChild(asteroid);
          }
        }

        startParticleSystem() {
          const particlesContainer =
            this.container.querySelector(".particles-layer");
          if (!particlesContainer) return;
          const screenInstance = this;
          this.particleSystem = {
            container: particlesContainer,
            particles: [],
            maxParticles: 20,
            createParticle() {
              const particle = document.createElement("div");
              particle.className = "particle";
              const size = Math.random() * 3 + 1;
              particle.style.width = particle.style.height = size + "px";
              particle.style.left = Math.random() * 100 + "%";
              particle.style.animationDelay = Math.random() * 2 + "s";
              particle.style.animationDuration = 8 + Math.random() * 6 + "s";
              particlesContainer.appendChild(particle);
              this.particles.push(particle);
              const timeout = setTimeout(() => {
                if (particle.parentNode) {
                  particle.remove();
                  const index = this.particles.indexOf(particle);
                  if (index > -1) {
                    this.particles.splice(index, 1);
                  }
                }
              }, 14000);
              screenInstance.timeouts.push(timeout);
            },
            start() {
              const interval = setInterval(() => {
                if (this.particles.length < this.maxParticles) {
                  this.createParticle();
                }
              }, 800);
              screenInstance.intervals.push(interval);
            },
          };
          this.particleSystem.start();
        }

        initializeAudio() {
          this.audioManager = {
            enabled: false,
            sounds: {},
            enable() {
              this.enabled = true;
              console.log(`üîä ${this.screenName} Screen audio enabled`);
            },
            playSound(soundName, loop = false, volume = 1.0) {
              if (!this.enabled) return;
              console.log(
                `üéµ Playing sound: ${soundName}${
                  loop ? " (looped)" : ""
                } at volume ${volume}`
              );
            },
            stopSound(soundName) {
              if (!this.enabled || !this.sounds[soundName]) return;
              console.log(`üîá Stopped sound: ${soundName}`);
            },
            stopAllSounds() {
              Object.keys(this.sounds).forEach((soundName) => {
                this.stopSound(soundName);
              });
            },
          };
        }

        enableAudio() {
          if (this.audioManager) {
            this.audioManager.enable();
          }
        }

        updateElementSafe(elementId, content) {
          const element = document.getElementById(elementId);
          if (element) {
            if (typeof content === "string") {
              element.textContent = content;
            } else {
              element.innerHTML = content;
            }
          }
        }

        showSuccessMessage(message) {
          const existing = document.querySelector(".success-message");
          if (existing) {
            existing.remove();
          }
          const successDiv = document.createElement("div");
          successDiv.className = "success-message";
          successDiv.innerHTML = message.replace(/\n/g, "<br>");
          document.body.appendChild(successDiv);
          if (this.audioManager) {
            this.audioManager.playSound("success");
          }
          const timeout = setTimeout(() => {
            if (successDiv.parentNode) {
              successDiv.remove();
            }
          }, 4000);
          this.timeouts.push(timeout);
        }

        showTemporaryMessage(message, type = "info", duration = 3000) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `temporary-message ${type}`;
          messageDiv.textContent = message;
          messageDiv.style.cssText = `
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: ${
              type === "warning"
                ? "rgba(255, 193, 7, 0.9)"
                : type === "error"
                ? "rgba(220, 53, 69, 0.9)"
                : type === "success"
                ? "rgba(40, 167, 69, 0.9)"
                : "rgba(0, 123, 255, 0.9)"
            };
            color: white; padding: 15px 25px; border-radius: 8px; font-weight: bold;
            z-index: 1002; animation: slideInDown 0.5s ease-out;
          `;
          document.body.appendChild(messageDiv);
          const timeout = setTimeout(() => {
            if (messageDiv.parentNode) {
              messageDiv.style.animation = "slideOutUp 0.5s ease-in forwards";
              setTimeout(() => messageDiv.remove(), 500);
            }
          }, duration);
          this.timeouts.push(timeout);
        }

        triggerScreenShake(duration = 300) {
          if (this.isShaking) return;
          this.isShaking = true;
          if (!document.body.classList.contains("shaking")) {
            document.body.classList.add("shaking");
          }
          if (!this.container.classList.contains("screen-shake")) {
            this.container.classList.add("screen-shake");
          }
          const timeout = setTimeout(() => {
            this.container.classList.remove("screen-shake");
            document.body.classList.remove("shaking");
            this.isShaking = false;
          }, duration);
          this.timeouts.push(timeout);
        }

        createParticleBurst(
          x,
          y,
          count = 12,
          color = "rgba(0, 255, 136, 0.8)"
        ) {
          for (let i = 0; i < count; i++) {
            const particle = document.createElement("div");
            particle.style.cssText = `
              position: absolute; width: ${Math.random() * 6 + 3}px; 
              height: ${Math.random() * 6 + 3}px; background: ${color};
              border-radius: 50%; pointer-events: none; z-index: 1000;
              left: ${x}px; top: ${y}px;
            `;
            document.body.appendChild(particle);
            const angle = (360 / count) * i;
            const distance = 60 + Math.random() * 40;
            const radians = (angle * Math.PI) / 180;
            const moveX = Math.cos(radians) * distance;
            const moveY = Math.sin(radians) * distance;
            particle.animate(
              [
                { transform: "translate(0, 0) scale(1)", opacity: 1 },
                {
                  transform: `translate(${moveX}px, ${moveY}px) scale(0)`,
                  opacity: 0,
                },
              ],
              {
                duration: 800,
                easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
              }
            ).onfinish = () => {
              particle.remove();
            };
          }
        }

        createRippleEffect(element, event, color = "rgba(0, 255, 136, 0.6)") {
          const ripple = document.createElement("div");
          ripple.className = "ripple-effect";
          const rect = element.getBoundingClientRect();
          const size = 50;
          const x = event.clientX - rect.left - size / 2;
          const y = event.clientY - rect.top - size / 2;
          ripple.style.cssText = `
            position: absolute; width: ${size}px; height: ${size}px;
            background: radial-gradient(circle, ${color} 0%, rgba(0, 255, 136, 0.2) 70%, transparent 100%);
            border-radius: 50%; pointer-events: none;
            animation: rippleEffect 0.6s ease-out forwards;
            left: ${x}px; top: ${y}px; z-index: 1;
          `;
          element.appendChild(ripple);
          const timeout = setTimeout(() => {
            if (ripple.parentNode) {
              ripple.remove();
            }
          }, 600);
          this.timeouts.push(timeout);
        }

        injectCSS(styleId, cssContent) {
          if (document.getElementById(styleId)) return;
          const styles = document.createElement("style");
          styles.id = styleId;
          styles.textContent = cssContent;
          document.head.appendChild(styles);
        }

        destroy() {
          this.intervals.forEach((interval) => clearInterval(interval));
          this.intervals = [];
          this.timeouts.forEach((timeout) => clearTimeout(timeout));
          this.timeouts = [];
          if (this.audioManager) {
            this.audioManager.stopAllSounds();
          }
          const tempMessages = document.querySelectorAll(
            ".temporary-message, .success-message"
          );
          tempMessages.forEach((msg) => msg.remove());
          if (this.isShaking) {
            document.body.classList.remove("shaking");
            this.container.classList.remove("screen-shake");
            this.isShaking = false;
          }
          this.isActive = false;
          console.log(`üóëÔ∏è ${this.screenName} Screen destroyed and cleaned up`);
        }

        setManagedInterval(callback, delay) {
          const interval = setInterval(callback, delay);
          this.intervals.push(interval);
          return interval;
        }

        setManagedTimeout(callback, delay) {
          const timeout = setTimeout(callback, delay);
          this.timeouts.push(timeout);
          return timeout;
        }

        debug() {
          console.log(`üìä ${this.screenName} Screen Debug Info:`, {
            isActive: this.isActive,
            isShaking: this.isShaking,
            intervals: this.intervals.length,
            timeouts: this.timeouts.length,
            particles: this.particleSystem?.particles?.length || 0,
            audioEnabled: this.audioManager?.enabled || false,
            config: this.config,
          });
        }
      }

      // Make available globally
      window.Screen = Screen;
      console.log("üì± Generic Screen base class loaded");
    </script>
    <script src="loading-screen.js"></script>
    <script src="start-screen.js"></script>
    <script src="app.js"></script>

    <!-- Development helpers -->
    <script>
      // Console welcome message
      console.log(`
        üéÆ Rusty vs. The Evil Tree
        ü¶ù Detective Game Loaded
        
        Debug Commands:
        - gameDebug.debug() - Show debug info
        - gameDebug.showScreen('screenName') - Switch screens
        - gameDebug.gameState - View game state
        
        Press F11 for fullscreen
        `);
    </script>
  </body>
</html>
